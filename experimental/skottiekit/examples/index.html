<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkottieKit Demo</title>

  <script type="text/javascript" src="/bin/skottiekit.js"></script>

  <script type="text/javascript" charset="utf-8">
    const bootTime = performance.now();
    // loadKit resolves with SkottieKit.
    const loadKit = SkottieKitInit({
      locateFile: (file) => '/bin/'+file,
    });

    loadKit.then(() => {
      const n = performance.now();
      console.log(`loaded Kit in ${(n - bootTime).toFixed(2)} ms`)
    });

    const loadLottieAssets = async (url, assets) => {
      return await Promise.all(assets.filter(asset => !asset.id.startsWith('comp_')).map(async (asset) => {
        var fullName = `${asset.u}${asset.p}`;
        var response = await fetch(`${url}/${fullName}`);
        var buffer = await response.arrayBuffer();
        return [asset.p, buffer];
      }));
    }

    const loadLottie = async (url) => {
      var lottieJson = await fetch(url).then((result) => {
        return result.text();
      });

      var parentUrl = url.substring(0, url.lastIndexOf('/'));
      var assets = await loadLottieAssets(parentUrl, JSON.parse(lottieJson).assets);
      
      if (assets.length > 0) {
        console.log('lottieJson: ', lottieJson);
      }

      return {
        json: lottieJson,
        assets: assets,
      }
    }

    function SkottieDemo(values, canvasID, width=400, height=400) {
      const [SkottieKit, lottie] = values;
      var assets = Object.fromEntries(lottie.assets);
      const animation = SkottieKit.MakeManagedAnimation(lottie.json, assets);

      const duration = animation.duration() * 1000;
      const size = animation.size();

      const bounds = {fLeft: 0, fTop: 0, fRight: width, fBottom: height};

      const surface = SkottieKit.MakeCanvasSurface(canvasID);
      if (!surface) {
        console.error('Could not make surface');
        return;
      }

      const firstFrame = Date.now();
      const clearColor = SkottieKit.WHITE;

      function drawFrame(canvas) {
        const seek = ((Date.now() - firstFrame) / duration) % 1.0;
        const damage = animation.seek(seek);

        if (damage.fRight > damage.fLeft && damage.fBottom > damage.fTop) {
          canvas.clear(clearColor);
          animation.render(canvas, bounds);
        }
        surface.requestAnimationFrame(drawFrame);
      }
      surface.requestAnimationFrame(drawFrame);
    }

    const googleCdn = 'https://storage.googleapis.com/skia-cdn/misc/';
    const arkieCdn = 'http://arkie-mocks.oss-cn-shanghai.aliyuncs.com/lottie/';
    const name = 'bmw-baokuang';
    const loadVideoJSON = loadLottie(`${arkieCdn}${name}/data.json`);
    const loadLegoJSON = loadLottie(googleCdn + 'lego_loader.json');
    const loadPartyJSON = loadLottie(googleCdn + 'confetti.json');
    const loadDrinksJSON = loadLottie(googleCdn + 'drinks.json');
    const loadOnboardingJSON = loadLottie(googleCdn + 'onboarding.json');

    const videoAnimating = Promise.all([loadKit, loadVideoJSON]).then((values) => {
      SkottieDemo(values, 'video', 400, 400);
    });
    const legosAnimating = Promise.all([loadKit, loadLegoJSON]).then((values) => {
      SkottieDemo(values, 'legos', 400, 400);
    });
    const partyAnimating = Promise.all([loadKit, loadPartyJSON]).then((values) => {
      SkottieDemo(values, 'party', 400, 400);
    });
    const drinksAnimating = Promise.all([loadKit, loadDrinksJSON]).then((values) => {
      SkottieDemo(values, 'drinks', 400, 400);
    });
    const onboardingAnimating = Promise.all([loadKit, loadOnboardingJSON]).then((values) => {
      SkottieDemo(values, 'onboarding', 400, 400);
    });

    Promise.all([videoAnimating, legosAnimating, partyAnimating, drinksAnimating, onboardingAnimating]).then(() => {
      const frames = new Float64Array(100);
      let idx = 0;
      let now = performance.now();
      function benchFrame() {
        frames[idx] = performance.now() - now;
        idx++;
        if (idx < frames.length) {
          now = performance.now();
          window.requestAnimationFrame(benchFrame);
        } else {
          let out = '';
          for (const frameTime of frames) {
            out += frameTime.toFixed(2);
            out += '\n';
          }
          console.log(out);
        }
      }
      window.requestAnimationFrame(benchFrame);
    })
  </script>

  <style>
    canvas {
      border: 1px dashed #AAA;
      width: 400px;
      height: 400px;
    }
  </style>

</head>
<body>
  <h1>SkottieKit</h1>

  <canvas id=video width=400 height=400></canvas>
  <canvas id=legos width=400 height=400></canvas>
  <canvas id=party width=400 height=400></canvas>
  <canvas id=drinks width=400 height=400></canvas>
  <canvas id=onboarding width=400 height=400></canvas>

</body>
</html>